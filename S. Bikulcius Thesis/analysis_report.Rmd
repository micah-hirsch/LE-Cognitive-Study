---
title: 'S. Bikulcius Thesis: Analysis'
author: "Micah E. Hirsch"
date: "2024-03-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

The purpose of this document is to report the results from the data analysis for S. Bikulcius' undergraduate thesis project. Analyses were conducted using R version 4.3.1.

```{r}

# Loading needed packages

library(tidyverse)
library(rio)
library(glmmTMB)
library(janitor)
library(ggpubr)
library(patchwork)
library(gt)
library(gtsummary)
library(ggridges)
library(performance)
library(sjPlot)
library(ggcorrplot)
library(lme4)
library(lmerTest)
library(optimx)

# Loading saved data

## Pupil Dilation Data

pupil <- rio::import("Data/cleaned_data.csv") |>
  # Getting Analysis Window
  dplyr::filter(timebins >= 500) |>
  dplyr::group_by(subject, trial) |>
  dplyr::filter(timebins <= max(timebins) - 2000) |>
  dplyr::ungroup() |>
  # Getting Peak Pupil Dilation Value
  dplyr::group_by(subject, trial, speaker, code, rep_acc, target_number, correct_words, effort_rating) |>
  dplyr::summarize(peak_pupil = max(pupil.binned)) |>
  dplyr::ungroup()

## Cognitive Data

cog <- rio::import("Data/cleaned_cog_data.csv")

## Listener Demographics

demo <- rio::import("Data/cleaned_listener_demo.csv") |>
  dplyr::mutate(gender = factor(gender, levels = c("Man", "Woman", "Nonbinary", "Questioning", "Prefer not to answer")),
                ethnicity = factor(ethnicity, levels = c("Hispanic/Latino(a/e)", "Not Hispanic/Latino(a/e)", "Prefer not to answer")),
                race = factor(race, levels = c("white/Caucasian", "Black/African American", "Asian/Asian American",
                                               "Native Hawaiian or Other Pacific Islander", "Native American or Alaska Native",
                                               "Biracial or Multiracial", "Prefer not to answer", "Race not listed")),
                native_lang = factor(native_lang, c("American English", "Not American English"))) |>
  dplyr::rename(subject = id)
```

# Listener Characteristics

## Demographics

The participant age range is from 18 to 39 years old. All participants reported they were fluent in English. However, two participants indicated that their native language is not American English. Their native languages were Spanish and Turkish respectively.

```{r}

demo_table <- demo |>
  dplyr::select(age, gender, ethnicity, race, native_lang) |>
  tbl_summary(type = list(age ~ "continuous",
                          gender ~ "categorical",
                          ethnicity ~ "categorical",
                          race ~ "categorical",
                          native_lang ~ "categorical"),
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              digits = list(everything() ~ c(2)),
              label = list(age ~ "Age",
                           gender ~ "Gender",
                           ethnicity ~ "Ethnicity",
                           race ~ "Race",
                           native_lang ~ "Native Language")) |>
  as_gt()

demo_table

demo_table |>
  gt::gtsave("Tables/demo_table.html")

```

## Cognition

It appears that the listeners in this analysis had about average working memory and cognitive flexibility skills. Their inhibitory control scores were slightly below average and they tend to have higher processing speed scores (on the higher end in the average range). The score distributions for working memory, cognitive flexibility, and inhibitory control roughly follow a normal distribution. The scores for processing speed appears to have more variation overall, and potentially has a bimodal distribution.

### Descriptives

```{r}

cog_table <- cog |>
  dplyr::select(-subject) |>
  # Just using the age-corrected scores
  dplyr::select(ends_with("_c")) |>
  tbl_summary(statistic = list(all_continuous() ~ "{mean} ({sd})"),
              digits = list(everything() ~ c(2)),
              label = list(list_sort_c ~ "Working Memory",
                           flanker_c ~ "Inhibitory Control",
                           card_sort_c ~ "Cognitive Flexibility",
                           pattern_c ~ "Processing Speed")) |>
  as_gt()

cog_table

cog_table |>
  gt::gtsave("Tables/cog_table.html")

```

### Distribution

```{r}

cog |>
  dplyr::select(subject, ends_with("_c")) |>
  tidyr::pivot_longer(cols = list_sort_c:pattern_c,
                      names_to = "cog_measure",
                      values_to = "score") |>
  ggplot() +
  aes(x = score,
      y = cog_measure,
      color = cog_measure,
      fill = cog_measure) +
  geom_density_ridges(jittered_points = T,
                      position = position_points_jitter(width = 0.05, height = 0),
                      point_shape = '|', point_size = 3, point_alpha = 1, alpha = 0.5) +
  theme_classic()

```

```{r}

rm(demo, demo_table)

```

### Correlations Among Cognitive Measures

For our analysis, it is important to consider the correlations between working memory, inhibitory control, cognitive flexibility, and processing speed. The figure below shows a correlation matrix. The pearson correlation coefficients are in each block and the color of the block relates to how strong the correlations are. Values closer to 1 or -1 suggest a stronger positive or negative correlation between the two cognitive measures, respectively.

The correlation matrix below shows a moderate positive correlation between cognitive flexibility and processing speed. There are also weak-to-moderate correlations between inhibitory control and cognitive flexibility and processing speed and working memory. This means the following:

-   Listeners with higher processing speed scores also tend to have higher processing speed scores
-   Listeners with higher inhibitory control scores also tend to have higher cognitive flexibility scores
-   Listeners with higher processing speed scores also tend to have higher working memory scores

```{r}

cog |>
  dplyr::select(ends_with("_c")) |>
  dplyr::rename('Working Memory' = list_sort_c,
                'Inhibitory Control' = flanker_c,
                'Cognitive Flexibility' = card_sort_c,
                'Processing Speed' = pattern_c) |>
  cor(use = "pairwise.complete.obs") |>
  ggcorrplot(
    type = "lower",
    outline.col = "white",
    lab = TRUE,
    insig = "blank",
    legend.title = "Correlation"
  )

```

# Speaker Characteristics

In this study, we use speech samples from two speakers: a control speaker with neurotypical speech and a speaker with dysarthria secondary to Amyotropic Lateral Sclerosis (ALS). The mean speaker intelligibility is reported below. This was calculated using the listener responses. Although the speaker with ALS has a mean intelligibility of approximately 82%, about listeners still repeated approximately half of their trials incorrectly. When listening to the control speaker, there was a higher proportion of accurate responses.

```{r}

pupil <- pupil |>
  # removing trials with missing rep accuracy
  dplyr::mutate(rep_acc = ifelse(rep_acc == "", NA, rep_acc)) |>
  dplyr::filter(!is.na(rep_acc)) |>
  dplyr::mutate(speaker = factor(speaker, levels = c("Control", "ALS")),
                trial_c = trial - 6,
                rep_acc = factor(rep_acc, levels = c("accurate", "inaccurate"))) |>
  # recoding missing effort ratings (negative effort ratings indicate missing data)
  dplyr::mutate(effort_rating = ifelse(effort_rating < 0, NA, effort_rating))

speaker_table <- pupil |>
  dplyr::select(subject, trial, speaker, correct_words, target_number, rep_acc) |>
  dplyr::distinct() |>
  dplyr::mutate(intel = (correct_words/target_number)*100) |>
  dplyr::select(-c(subject, trial, correct_words, target_number)) |>
  tbl_summary(by = speaker,
              type = list(intel ~ "continuous",
                          rep_acc ~ "categorical"),
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              digits = list(everything() ~ c(2)),
              label = list(intel ~ "Intelligibility",
                           rep_acc ~ "Repetition Accuracy")) |>
  as_gt()

speaker_table

speaker_table |>
  gt::gtsave("Tables/speaker_table.html")

```

```{r}

rm(speaker_table, cog_table)

```

# Listening Effort

## Descriptives

### Listening Effort For Intelligible Phrases

Mean peak pupil dilation values (arbitrary units) and mean effort ratings for accurately-recognized phrases for each speaker is reported in the table below.

```{r}

effort_table <- pupil |>
  dplyr::filter(rep_acc == "accurate") |>
  dplyr::select(speaker, peak_pupil, effort_rating) |>
  tbl_summary(
        by = speaker,
        type = list(peak_pupil ~ "continuous",
                    effort_rating ~ "continuous"),
        statistic = list(all_continuous() ~ c("{mean} ({sd})")),
        missing = "no",
        digits = all_continuous() ~ 2,
        label = list(peak_pupil ~ "Peak Pupil Dilation",
                     effort_rating ~"Perceived Listening Effort")
      ) |>
  as_gt()

effort_table

effort_table |>
  gt::gtsave("Tables/effort_table.html")

```

### Listening Effort: Comparing Intelligible and Non-Intelligible Phrases

Mean peak pupil dilation values (arbitrary units) and mean effort ratings for when listener's accurately and inaccurately recognized the phrase for each speaker is reported below.

```{r}

effort_table2 <- pupil |>
  dplyr::select(speaker, peak_pupil, effort_rating, rep_acc) |>
  tbl_strata(
    strata = rep_acc,
    ~.x |>
      tbl_summary(
        by = speaker,
        type = list(peak_pupil ~ "continuous",
                    effort_rating ~ "continuous"),
        statistic = list(all_continuous() ~ c("{mean} ({sd})")),
        missing = "no",
        digits = all_continuous() ~ 2,
        label = list(peak_pupil ~ "Peak Pupil Dilation",
                     effort_rating ~"Perceived Listening Effort")
      )) |>
  as_gt()

effort_table2

effort_table2 |>
  gt::gtsave("Tables/effort_table_accuracy.html")

```


```{r}

rm(effort_table, effort_table2)

```


## Pupil Dilation

### Visualizations

#### Overall Peak Pupil Dilation

Figure showing peak pupil dilation for accurately recognized phrases for the control and ALS speakers.

```{r}

pupil_des <- pupil |>
  dplyr::group_by(speaker, rep_acc) |>
  dplyr::summarize(pupil = mean(peak_pupil, na.rm = T), 
                   sd = sd(peak_pupil, na.rm = T),
                   se = sd/sqrt(n())) |>
  ungroup()

pupil_des |>
  dplyr::filter(rep_acc == "accurate") |>
  ggplot() +
   aes(x = speaker,
       y = pupil,
       group = speaker,
       color = speaker,
       fill = speaker) +
  geom_bar(stat = "identity", alpha = 0.5) +
  geom_errorbar(aes(ymin = pupil - se, ymax = pupil + se), width = 0.4) +
  labs(x = "Speaker", y = "Peak Pupil Dilation (Arbitrary Units)") +
  theme_bw() +
  theme(aspect.ratio = 1)

```

Figure showing peak pupil dilation for accurately and inaccurately recognized phrases for the control and ALS speakers.

```{r}

pupil_des |>
  ggplot() +
   aes(x = rep_acc,
       y = pupil,
       group = speaker,
       color = speaker,
       fill = speaker) +
  geom_bar(stat = "identity", alpha = 0.5, position = position_dodge()) +
  geom_errorbar(aes(ymin = pupil - se, ymax = pupil + se), width = 0.4, position = position_dodge(.9)) +
  labs(x = "Accuracy", y = "Peak Pupil Dilation (Arbitrary Units)") +
  theme_bw() +
  theme(aspect.ratio = 1)

```

#### Pupil Dilation Predicted by Listener Cognition

Average Peak Pupil Dilation vs Cognitive Scores

```{r}

pupil1 <- dplyr::left_join(pupil, cog, by = "subject") 

pupil1 |>
  dplyr::filter(rep_acc == "accurate") |>
  dplyr::select(subject, trial, speaker, code, peak_pupil, ends_with("_c")) |>
  dplyr::group_by(subject, speaker, list_sort_c, flanker_c, card_sort_c, pattern_c) |>
  dplyr::summarize(pupil = mean(peak_pupil)) |>
  tidyr::pivot_longer(cols = list_sort_c:pattern_c,
                     names_to = "cog_measure",
                     values_to = "score") |>
  ungroup() |>
  ggplot() +
  aes(x = score,
      y = pupil,
      color = speaker,
      ) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm") +
  facet_wrap("cog_measure") +
  theme_classic() +
  theme(aspect.ratio = 1)

```

```{r}

pupil1 |>
  dplyr::select(subject, trial, speaker, code, rep_acc, peak_pupil, ends_with("_c")) |>
  dplyr::group_by(subject, speaker, rep_acc, list_sort_c, flanker_c, card_sort_c, pattern_c) |>
  dplyr::summarize(pupil = mean(peak_pupil)) |>
  tidyr::pivot_longer(cols = list_sort_c:pattern_c,
                     names_to = "cog_measure",
                     values_to = "score") |>
  ungroup() |>
  ggplot() +
  aes(x = score,
      y = pupil,
      color = rep_acc,
      ) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm") +
  facet_grid(cog_measure ~ speaker) +
  theme_classic() +
  theme(aspect.ratio = 1)

ggsave("Figures/peak_pupil_cog_plot.png", plot = last_plot())

```

### Analysis

Given our sample size and the primary question for this thesis project, we are just going to analyze the accurately recognized phrases for each speaker (i.e. 100% intelligible phrases). To analyze the relationships between listener cognition and listening effort, we are using linear mixed effects models. 

#### Unconditional Model

```{r}

accurate_df <- pupil1 |>
  dplyr::filter(rep_acc == "accurate")

m0 <- glmmTMB(peak_pupil ~ 1 + (1|subject) + (1|code), data = accurate_df)
summary(m0)
performance::icc(m0)


```

#### Model 1

```{r}

m1 <- glmmTMB(peak_pupil ~ trial_c + (1|subject) + (1|code), data = accurate_df)
summary(m1)
performance::compare_performance(m0, m1)
performance::test_performance(m0, m1)

```

#### Model 2

```{r}

m2 <- glmmTMB(peak_pupil ~ trial_c + speaker + (1|subject) + (1|code), data = accurate_df)
summary(m2)
performance::compare_performance(m1, m2)
performance::test_performance(m1, m2)

```

#### Model 2b

```{r}

m2b <- glmmTMB(peak_pupil ~ trial_c + speaker + (1|subject), data = accurate_df)
summary(m2b)
performance::compare_performance(m2, m2b)
performance::test_performance(m2, m2b)

```


#### Model 3

```{r}

m3 <- glmmTMB(peak_pupil ~ trial_c + speaker + list_sort_c + (1|subject) + (1|code), data = accurate_df)
summary(m3)
performance::compare_performance(m2, m3)
performance::test_performance(m2, m3)

```

#### Model 3b

```{r}

m3b <- glmmTMB(peak_pupil ~ trial_c + speaker + list_sort_c + (1|subject), data = accurate_df)
summary(m3b)
performance::compare_performance(m3, m3b)
performance::test_performance(m3, m3b)

```

#### Comparing Model 3b with Model 2

```{r}

performance::compare_performance(m2, m3b)
performance::test_performance(m2, m3b)

```


#### Model 4

```{r}

m4 <- glmmTMB(peak_pupil ~ trial_c + speaker + flanker_c + (1|subject), data = accurate_df)
summary(m4)
performance::compare_performance(m2b, m4)
performance::test_performance(m2b, m4)

```

#### Model 5

```{r}

m5 <- glmmTMB(peak_pupil ~ trial_c + speaker + card_sort_c + (1|subject), data = accurate_df)
summary(m5)
performance::compare_performance(m2b, m5)
performance::test_performance(m2b, m5)

```

#### Model 6

```{r}

m6 <- glmmTMB(peak_pupil ~ trial_c + speaker + pattern_c + (1|subject), data = accurate_df)
summary(m6)
performance::compare_performance(m2b, m6)
performance::test_performance(m2b, m6)

```

#### Model 7

```{r}

m7 <- glmmTMB(peak_pupil ~ trial_c + speaker + list_sort_c*speaker + (1|subject), data = accurate_df)
summary(m7)
performance::compare_performance(m2b, m7)
performance::test_performance(m2b, m7)

```

#### Model 8

```{r}

m8 <- glmmTMB(peak_pupil ~ trial_c + speaker + list_sort_c*speaker + flanker_c*speaker + (1|subject), data = accurate_df)
summary(m8)
performance::compare_performance(m7, m8)
performance::test_performance(m7, m8)

```

#### Model 9

```{r}

m9 <- glmmTMB(peak_pupil ~ trial_c + speaker + list_sort_c*speaker + card_sort_c*speaker + (1|subject), data = accurate_df)
summary(m9)
performance::compare_performance(m7, m9)
performance::test_performance(m7, m9)

```

#### Model 10

```{r}

m10 <- glmmTMB(peak_pupil ~ trial_c + speaker + list_sort_c*speaker + pattern_c*speaker + (1|subject), data = accurate_df)
summary(m10)
performance::compare_performance(m7, m10)
performance::test_performance(m7, m10)

```

#### Final Model

```{r}

summary(m7)

```

